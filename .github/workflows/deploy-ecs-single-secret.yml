name: Deploy to AWS ECS (Single Secret)

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: perfect-po-dev-api
  ECS_CLUSTER: perfect-po-dev-cluster
  ECS_SERVICE: perfect-po-dev-api-service
  ECS_TASK_DEFINITION: perfect-po-dev-api-task

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Validate Environment Variables
      run: |
        echo "ğŸ” Validating environment variables before build..."
        echo "MONGODB_URI: ${{ secrets.MONGODB_URI != '' && 'SET' || 'MISSING' }}"
        echo "JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY != '' && 'SET' || 'MISSING' }}"
        echo "KEEPA_API_KEY: ${{ secrets.KEEPA_API_KEY != '' && 'SET' || 'MISSING' }}"
        echo "AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID != '' && 'SET' || 'MISSING' }}"
        echo "AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY != '' && 'SET' || 'MISSING' }}"
        
        # Check for required secrets
        if [ -z "${{ secrets.MONGODB_URI }}" ]; then
          echo "âŒ MONGODB_URI is missing"
          exit 1
        fi
        
        if [ -z "${{ secrets.JWT_SECRET_KEY }}" ]; then
          echo "âŒ JWT_SECRET_KEY is missing"
          exit 1
        fi
        
        if [ -z "${{ secrets.KEEPA_API_KEY }}" ]; then
          echo "âŒ KEEPA_API_KEY is missing"
          exit 1
        fi
        
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "âŒ AWS_ACCESS_KEY_ID is missing"
          exit 1
        fi
        
        if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "âŒ AWS_SECRET_ACCESS_KEY is missing"
          exit 1
        fi
        
        # Check for localhost in MongoDB URI
        if [[ "${{ secrets.MONGODB_URI }}" == *"localhost"* ]] || [[ "${{ secrets.MONGODB_URI }}" == *"127.0.0.1"* ]]; then
          echo "âŒ MONGODB_URI contains localhost - must use remote MongoDB"
          exit 1
        fi
        
        echo "âœ… All required environment variables are set and valid!"
        echo "âœ… MongoDB URI is remote (no localhost)"

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build a docker container and push it to ECR
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Create/Update AWS Secret
      run: |
        # Create the ENV_FILE content with all environment variables
        cat > env_file_content << EOF
        MONGODB_URL=${{ secrets.MONGODB_URI }}
        JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
        KEEPA_API_KEY=${{ secrets.KEEPA_API_KEY }}
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        ENVIRONMENT=dev
        AWS_REGION=us-east-1
        DEBUG=false
        EOF
        
        # Try to update existing secret, create if it doesn't exist
        if aws secretsmanager describe-secret --secret-id "perfect-po-env-file" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
          echo "Updating existing secret..."
          aws secretsmanager update-secret \
            --secret-id "perfect-po-env-file" \
            --secret-string "$(cat env_file_content)" \
            --region ${{ env.AWS_REGION }}
        else
          echo "Creating new secret..."
          aws secretsmanager create-secret \
            --name "perfect-po-env-file" \
            --description "Environment variables for Perfect PO API" \
            --secret-string "$(cat env_file_content)" \
            --region ${{ env.AWS_REGION }}
        fi

    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: deployment/aws/ecs-task-definition-single-secret.json
        container-name: perfect-po-api
        image: ${{ steps.build-image.outputs.image }}

    - name: Deploy Amazon ECS task definition
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: true

    - name: Get the service URL from ECS
      id: service-url
      run: |
        # Get the load balancer DNS name
        SERVICE_ARN=$(aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --services ${{ env.ECS_SERVICE }} --region ${{ env.AWS_REGION }} --query 'services[0].loadBalancers[0].targetGroupArn' --output text)
        if [ "$SERVICE_ARN" != "None" ] && [ "$SERVICE_ARN" != "" ]; then
          TARGET_GROUP_ARN=$(echo $SERVICE_ARN)
          LOAD_BALANCER_ARN=$(aws elbv2 describe-target-groups --target-group-arns $TARGET_GROUP_ARN --region ${{ env.AWS_REGION }} --query 'TargetGroups[0].LoadBalancerArns[0]' --output text)
          if [ "$LOAD_BALANCER_ARN" != "None" ] && [ "$LOAD_BALANCER_ARN" != "" ]; then
            DNS_NAME=$(aws elbv2 describe-load-balancers --load-balancer-arns $LOAD_BALANCER_ARN --region ${{ env.AWS_REGION }} --query 'LoadBalancers[0].DNSName' --output text)
            echo "url=$DNS_NAME" >> $GITHUB_OUTPUT
            echo "Service URL: $DNS_NAME"
          else
            echo "url=None" >> $GITHUB_OUTPUT
            echo "No load balancer found"
          fi
        else
          echo "url=None" >> $GITHUB_OUTPUT
          echo "No target group found"
        fi

    - name: Wait a bit for the service to be fully ready
      run: |
        if [ "${{ steps.service-url.outputs.url }}" != "None" ]; then
          echo "Waiting for service to be ready..."
          sleep 30
        else
          echo "No load balancer URL found, skipping health check"
        fi

    - name: Health check
      run: |
        if [ "${{ steps.service-url.outputs.url }}" != "None" ]; then
          echo "Testing health endpoint..."
          curl -f http://${{ steps.service-url.outputs.url }}/health || echo "Health check failed"
        else
          echo "âš ï¸  No load balancer URL found, skipping health check"
        fi

    - name: Deployment Summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“± Service URL: ${{ steps.service-url.outputs.url }}"
        echo "ğŸ³ Image: ${{ steps.build-image.outputs.image }}"
        echo "ğŸ—ï¸  Environment: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
