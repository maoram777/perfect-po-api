# üöÄ EC2 Deployment Guide for Perfect PO API

## üìã Overview

This guide covers deploying your FastAPI application on AWS EC2 using Docker and Docker Compose for production-ready deployment.

## üèóÔ∏è **Architecture Overview**

```
Internet ‚Üí EC2 Instance ‚Üí Nginx ‚Üí FastAPI ‚Üí MongoDB + Redis
                ‚Üì
        Docker Compose Stack
```

**Components:**
- **FastAPI Application**: Main API server
- **Nginx**: Reverse proxy, SSL termination, load balancing
- **MongoDB**: Primary database
- **Redis**: Caching layer
- **Docker Compose**: Container orchestration

## üîß **Prerequisites**

### **AWS Setup**
- AWS Account with EC2 access
- EC2 instance running Ubuntu 20.04+ or Amazon Linux 2
- Security groups configured
- IAM role with necessary permissions

### **Instance Requirements**
- **Minimum**: t3.small (2 vCPU, 2GB RAM)
- **Recommended**: t3.medium (2 vCPU, 4GB RAM)
- **Production**: t3.large+ (2+ vCPU, 8GB+ RAM)

### **Security Group Configuration**
```
Inbound Rules:
- HTTP (80): 0.0.0.0/0
- HTTPS (443): 0.0.0.0/0
- SSH (22): Your IP address
- MongoDB (27017): 0.0.0.0/0 (or restrict to VPC)
- Redis (6379): 0.0.0.0/0 (or restrict to VPC)
- MongoDB Express (8081): 0.0.0.0/0 (optional)
```

## üöÄ **Quick Deployment**

### **Step 1: Connect to EC2**
```bash
# SSH to your EC2 instance
ssh -i your-key.pem ubuntu@your-ec2-ip

# Update system
sudo apt update && sudo apt upgrade -y
```

### **Step 2: Clone Repository**
```bash
# Clone your repository
git clone https://github.com/yourusername/perfect-po-api.git
cd perfect-po-api

# Make deployment script executable
chmod +x deploy_ec2.sh
```

### **Step 3: Configure Environment**
```bash
# Copy and edit production environment file
cp env.prod.template .env.prod
nano .env.prod

# Key values to set:
# - MONGO_ROOT_PASSWORD (secure password)
# - JWT_SECRET_KEY (very long random string)
# - KEEPA_API_KEY (your Keepa API key)
# - AWS credentials
```

### **Step 4: Deploy**
```bash
# Deploy to production
./deploy_ec2.sh production your-domain.com

# Or for local testing
./deploy_ec2.sh production localhost
```

## üîê **Environment Configuration**

### **Required Environment Variables**
```bash
# Application
ENVIRONMENT=production
DEBUG=false

# MongoDB
MONGO_ROOT_USERNAME=admin
MONGO_ROOT_PASSWORD=your_secure_password_here

# JWT
JWT_SECRET_KEY=your_very_long_and_secure_jwt_secret_key_here
JWT_EXPIRATION_MINUTES=10080

# Keepa API
KEEPA_API_KEY=your_keepa_api_key_here

# AWS Configuration
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_aws_access_key_id
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
AWS_S3_BUCKET=your_s3_bucket_name
```

### **Security Best Practices**
- ‚úÖ **Strong passwords**: Use 16+ character passwords
- ‚úÖ **JWT secret**: 64+ character random string
- ‚úÖ **Restrict access**: Limit MongoDB/Redis to VPC
- ‚úÖ **Regular updates**: Keep system and containers updated
- ‚úÖ **SSL certificates**: Use proper certificates for production

## üê≥ **Docker Services**

### **Service Overview**
```yaml
# FastAPI Application
api:
  - Port: 8000 (internal)
  - Memory: 2GB limit, 1GB reservation
  - CPU: 1.0 limit, 0.5 reservation
  - Health check: /health endpoint

# MongoDB Database
mongodb:
  - Port: 27017
  - Memory: 1GB limit
  - Persistent volume: mongodb_data

# Redis Cache
redis:
  - Port: 6379
  - Memory: 512MB limit
  - Persistent volume: redis_data

# Nginx Proxy
nginx:
  - Ports: 80 (HTTP), 443 (HTTPS)
  - Memory: 256MB limit
  - SSL termination and load balancing
```

### **Scaling Options**
```bash
# Scale API instances
docker-compose -f docker-compose.prod.yml up -d --scale api=3

# Scale with load balancer
# Add more api services in docker-compose.prod.yml
```

## üîí **SSL Configuration**

### **Self-Signed Certificate (Development)**
```bash
# Automatically generated by deploy script
# Valid for 365 days
# For development/testing only
```

### **Let's Encrypt (Production)**
```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Get certificate
sudo certbot --nginx -d your-domain.com

# Auto-renewal
sudo crontab -e
# Add: 0 12 * * * /usr/bin/certbot renew --quiet
```

### **Custom SSL Certificate**
```bash
# Place your certificates in nginx/ssl/
# - cert.pem (certificate)
# - key.pem (private key)

# Update nginx.conf if needed
```

## üìä **Monitoring & Logging**

### **Container Logs**
```bash
# View all logs
docker-compose -f docker-compose.prod.yml logs -f

# View specific service logs
docker-compose -f docker-compose.prod.yml logs -f api
docker-compose -f docker-compose.prod.yml logs -f mongodb
docker-compose -f docker-compose.prod.yml logs -f nginx

# View recent logs
docker-compose -f docker-compose.prod.yml logs --tail=100
```

### **System Monitoring**
```bash
# Install monitoring tools
sudo apt install htop iotop nethogs

# Monitor system resources
htop
iotop
nethogs

# Check disk usage
df -h
du -sh /var/lib/docker/volumes/*
```

### **CloudWatch Integration**
```bash
# Install CloudWatch agent
sudo apt install amazon-cloudwatch-agent

# Configure monitoring
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
```

## üîÑ **Deployment Workflow**

### **Initial Deployment**
```bash
1. Launch EC2 instance
2. Configure security groups
3. Clone repository
4. Configure .env.prod
5. Run deploy_ec2.sh
6. Test endpoints
7. Configure DNS
```

### **Update Deployment**
```bash
1. Pull latest code
git pull origin main

2. Update environment (if needed)
nano .env.prod

3. Redeploy
./deploy_ec2.sh production your-domain.com

4. Verify deployment
curl https://your-domain.com/health
```

### **Rollback Strategy**
```bash
# Stop current deployment
docker-compose -f docker-compose.prod.yml down

# Checkout previous version
git checkout HEAD~1

# Redeploy previous version
./deploy_ec2.sh production your-domain.com
```

## üö® **Troubleshooting**

### **Common Issues**

1. **Port Already in Use**
   ```bash
   # Check what's using the port
   sudo netstat -tlnp | grep :80
   
   # Stop conflicting service
   sudo systemctl stop apache2  # if Apache is running
   ```

2. **Permission Denied**
   ```bash
   # Fix file permissions
   sudo chown -R $USER:$USER .
   chmod 600 .env.prod
   chmod 600 nginx/ssl/*.pem
   ```

3. **Container Won't Start**
   ```bash
   # Check container logs
   docker-compose -f docker-compose.prod.yml logs api
   
   # Check container status
   docker-compose -f docker-compose.prod.yml ps
   ```

4. **Database Connection Issues**
   ```bash
   # Check MongoDB status
   docker exec perfect-po-mongodb mongosh --eval "db.adminCommand('ping')"
   
   # Check network connectivity
   docker exec perfect-po-api ping mongodb
   ```

### **Debug Commands**
```bash
# Check service health
curl -f http://localhost/health

# Check container resources
docker stats

# Check network
docker network ls
docker network inspect perfect-po-api_perfect-po-network

# Check volumes
docker volume ls
docker volume inspect perfect-po-api_mongodb_data
```

## üí∞ **Cost Optimization**

### **Instance Sizing**
- **Development**: t3.micro (free tier eligible)
- **Testing**: t3.small ($8-15/month)
- **Production**: t3.medium ($16-30/month)
- **High Traffic**: t3.large+ ($32+/month)

### **Storage Optimization**
- **EBS Volume**: Use gp3 for better performance/cost
- **Docker Images**: Regular cleanup of unused images
- **Logs**: Implement log rotation and retention

### **Resource Limits**
```yaml
# In docker-compose.prod.yml
deploy:
  resources:
    limits:
      memory: 1G  # Reduce from 2G if not needed
      cpus: '0.5' # Reduce from 1.0 if not needed
```

## üîí **Security Hardening**

### **Firewall Configuration**
```bash
# Install UFW
sudo apt install ufw

# Configure firewall
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### **Container Security**
```bash
# Run containers as non-root user (already configured)
# Regular security updates
sudo apt update && sudo apt upgrade -y

# Monitor for vulnerabilities
docker scout cves perfect-po-api:latest
```

### **Database Security**
```bash
# Change default passwords
# Restrict network access
# Enable authentication
# Regular backups
```

## üìö **Next Steps**

### **Immediate Actions**
1. ‚úÖ Deploy to EC2
2. ‚úÖ Test all endpoints
3. ‚úÖ Configure SSL certificates
4. ‚úÖ Set up monitoring

### **Production Readiness**
1. üîí Security audit
2. üìä Performance testing
3. üîÑ Backup strategy
4. üö® Alert configuration

### **Advanced Features**
1. üöÄ Auto-scaling
2. üîÑ CI/CD pipeline
3. üìä Advanced monitoring
4. üåç Multi-region deployment

---

**üéâ Your FastAPI application is now production-ready on EC2!**
